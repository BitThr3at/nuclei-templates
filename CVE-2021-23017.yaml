id: CVE-2021-23017

info:
  name: NGINX Resolver DNS Buffer Overflow
  author: ProjectDiscoveryAI
  severity: critical
  description: |
    This template detects the NGINX Resolver vulnerability (CVE-2021-23017), which is a buffer overflow vulnerability in the way NGINX handles DNS responses. An attacker can exploit this by sending crafted DNS responses to NGINX, potentially leading to remote code execution.
  remediation: |
    Upgrade to the latest version of NGINX where this vulnerability is patched. Ensure that your NGINX configuration does not use the resolver directive with untrusted DNS servers. Consider implementing network-level security controls to block malicious DNS responses.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2021-23017

tcp:
  - inputs:
      - data: "{{hex_decode('3a000000a741000000000000d40700000000000061646d696e2e24636d640000000000ffffffff130000001069736d6173746572000100000000')}}"
        type: hex
    host:
      - "{{Hostname}}"
    port: 53
    read-size: 2048

    matchers-condition: and
    matchers:
      # Match for abnormally large DNS response size indicative of buffer overflow attempt
      - type: size
        size:
          - 1024
        part: raw

      # Regex to detect potential malicious patterns related to crafted DNS responses
      - type: regex
        part: raw
        regex:
          - "^(?![a-zA-Z0-9.-]{1,253}\\.[a-zA-Z]{2,6}$).*"

      # Match on common DNS fields involved in crafting a buffer overflow
      - type: word
        part: raw
        words:
          - "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
          
      # Match for unusual TTL or record lengths that may suggest crafted packet for overflow
      - type: regex
        part: raw
        regex:
          - "([0-9]{6,})"

      # Check for unexpected resource record field sizes or data anomalies
      - type: word
        part: raw
        words:
          - "resource record"
          - "length"